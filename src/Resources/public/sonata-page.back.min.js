/*
 * This file is part of the Sonata Project package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./draggable","./mouse","../version","../widget"],e):e(jQuery)}(function(e){"use strict";return e.widget("ui.droppable",{version:"1.13.1",widgetEventPrefix:"drop",options:{accept:"*",addClasses:!0,greedy:!1,scope:"default",tolerance:"intersect",activate:null,deactivate:null,drop:null,out:null,over:null},_create:function(){var e,t=this.options,i=t.accept;this.isover=!1,this.isout=!0,this.accept="function"==typeof i?i:function(e){return e.is(i)},this.proportions=function(){return arguments.length?void(e=arguments[0]):e?e:e={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight}},this._addToManager(t.scope),t.addClasses&&this._addClass("ui-droppable")},_addToManager:function(t){e.ui.ddmanager.droppables[t]=e.ui.ddmanager.droppables[t]||[],e.ui.ddmanager.droppables[t].push(this)},_splice:function(e){for(var t=0;t<e.length;t++)e[t]===this&&e.splice(t,1)},_destroy:function(){var t=e.ui.ddmanager.droppables[this.options.scope];this._splice(t)},_setOption:function(t,i){if("accept"===t)this.accept="function"==typeof i?i:function(e){return e.is(i)};else if("scope"===t){var n=e.ui.ddmanager.droppables[this.options.scope];this._splice(n),this._addToManager(i)}this._super(t,i)},_activate:function(t){var i=e.ui.ddmanager.current;this._addActiveClass(),i&&this._trigger("activate",t,this.ui(i))},_deactivate:function(t){var i=e.ui.ddmanager.current;this._removeActiveClass(),i&&this._trigger("deactivate",t,this.ui(i))},_over:function(t){var i=e.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this._addHoverClass(),this._trigger("over",t,this.ui(i)))},_out:function(t){var i=e.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this._removeHoverClass(),this._trigger("out",t,this.ui(i)))},_drop:function(t,i){var n=i||e.ui.ddmanager.current,o=!1;return!(!n||(n.currentItem||n.element)[0]===this.element[0])&&(this.element.find(":data(ui-droppable)").not(".ui-draggable-dragging").each(function(){var i=e(this).droppable("instance");if(i.options.greedy&&!i.options.disabled&&i.options.scope===n.options.scope&&i.accept.call(i.element[0],n.currentItem||n.element)&&e.ui.intersect(n,e.extend(i,{offset:i.element.offset()}),i.options.tolerance,t))return o=!0,!1}),!o&&(!!this.accept.call(this.element[0],n.currentItem||n.element)&&(this._removeActiveClass(),this._removeHoverClass(),this._trigger("drop",t,this.ui(n)),this.element)))},ui:function(e){return{draggable:e.currentItem||e.element,helper:e.helper,position:e.position,offset:e.positionAbs}},_addHoverClass:function(){this._addClass("ui-droppable-hover")},_removeHoverClass:function(){this._removeClass("ui-droppable-hover")},_addActiveClass:function(){this._addClass("ui-droppable-active")},_removeActiveClass:function(){this._removeClass("ui-droppable-active")}}),e.ui.intersect=function(){function e(e,t,i){return e>=t&&e<t+i}return function(t,i,n,o){if(!i.offset)return!1;var a=(t.positionAbs||t.position.absolute).left+t.margins.left,r=(t.positionAbs||t.position.absolute).top+t.margins.top,s=a+t.helperProportions.width,c=r+t.helperProportions.height,l=i.offset.left,d=i.offset.top,p=l+i.proportions().width,h=d+i.proportions().height;switch(n){case"fit":return l<=a&&s<=p&&d<=r&&c<=h;case"intersect":return l<a+t.helperProportions.width/2&&s-t.helperProportions.width/2<p&&d<r+t.helperProportions.height/2&&c-t.helperProportions.height/2<h;case"pointer":return e(o.pageY,d,i.proportions().height)&&e(o.pageX,l,i.proportions().width);case"touch":return(r>=d&&r<=h||c>=d&&c<=h||r<d&&c>h)&&(a>=l&&a<=p||s>=l&&s<=p||a<l&&s>p);default:return!1}}}(),e.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(t,i){var n,o,a=e.ui.ddmanager.droppables[t.options.scope]||[],r=i?i.type:null,s=(t.currentItem||t.element).find(":data(ui-droppable)").addBack();e:for(n=0;n<a.length;n++)if(!(a[n].options.disabled||t&&!a[n].accept.call(a[n].element[0],t.currentItem||t.element))){for(o=0;o<s.length;o++)if(s[o]===a[n].element[0]){a[n].proportions().height=0;continue e}a[n].visible="none"!==a[n].element.css("display"),a[n].visible&&("mousedown"===r&&a[n]._activate.call(a[n],i),a[n].offset=a[n].element.offset(),a[n].proportions({width:a[n].element[0].offsetWidth,height:a[n].element[0].offsetHeight}))}},drop:function(t,i){var n=!1;return e.each((e.ui.ddmanager.droppables[t.options.scope]||[]).slice(),function(){this.options&&(!this.options.disabled&&this.visible&&e.ui.intersect(t,this,this.options.tolerance,i)&&(n=this._drop.call(this,i)||n),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],t.currentItem||t.element)&&(this.isout=!0,this.isover=!1,this._deactivate.call(this,i)))}),n},dragStart:function(t,i){t.element.parentsUntil("body").on("scroll.droppable",function(){t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,i)})},drag:function(t,i){t.options.refreshPositions&&e.ui.ddmanager.prepareOffsets(t,i),e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var n,o,a,r=e.ui.intersect(t,this,this.options.tolerance,i),s=!r&&this.isover?"isout":r&&!this.isover?"isover":null;s&&(this.options.greedy&&(o=this.options.scope,a=this.element.parents(":data(ui-droppable)").filter(function(){return e(this).droppable("instance").options.scope===o}),a.length&&(n=e(a[0]).droppable("instance"),n.greedyChild="isover"===s)),n&&"isover"===s&&(n.isover=!1,n.isout=!0,n._out.call(n,i)),this[s]=!0,this["isout"===s?"isover":"isout"]=!1,this["isover"===s?"_over":"_out"].call(this,i),n&&"isout"===s&&(n.isout=!1,n.isover=!0,n._over.call(n,i)))}})},dragStop:function(t,i){t.element.parentsUntil("body").off("scroll.droppable"),t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,i)}},e.uiBackCompat!==!1&&e.widget("ui.droppable",e.ui.droppable,{options:{hoverClass:!1,activeClass:!1},_addActiveClass:function(){this._super(),this.options.activeClass&&this.element.addClass(this.options.activeClass)},_removeActiveClass:function(){this._super(),this.options.activeClass&&this.element.removeClass(this.options.activeClass)},_addHoverClass:function(){this._super(),this.options.hoverClass&&this.element.addClass(this.options.hoverClass)},_removeHoverClass:function(){this._super(),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass)}}),e.ui.droppable}),function(e,t){function i(e){"undefined"==typeof t.admin&&Admin.shared_setup(e)}var n=function(t,i){var n=i||{};this.pageId=t,this.$container=e(".page-composer"),this.$dynamicArea=e(".page-composer__dyn-content"),this.$pagePreview=e(".page-composer__page-preview"),this.$containerPreviews=this.$pagePreview.find(".page-composer__page-preview__container"),this.routes=e.extend({},n.routes||{}),this.translations=e.extend({},n.translations||{}),this.csrfTokens=e.extend({},n.csrfTokens||{}),this.bindPagePreviewHandlers(),this.bindOrphansHandlers();var o=this,a=e(this);a.on("containerclick",function(e){o.loadContainer(e.$container)}),a.on("containerloaded",this.handleContainerLoaded),a.on("blockcreated",this.handleBlockCreated),a.on("blockremoved",this.handleBlockRemoved),a.on("blockcreateformloaded",this.handleBlockCreateFormLoaded),a.on("blockpositionsupdate",this.handleBlockPositionsUpdate),a.on("blockeditformloaded",this.handleBlockEditFormLoaded),a.on("blockparentswitched",this.handleBlockParentSwitched)};n.prototype={translate:function(e){return this.translations[e]?this.translations[e]:e},getRouteUrl:function(e,t){if(!this.routes[e])throw new Error('Route "'+e+'" does not exist');var i=this.routes[e];for(var n in t)i=i.replace(new RegExp(n),t[n]);return i},isFormControlTypeByName:function(e,t){if("undefined"!=typeof e){var i=e.length,n="["+t+"]",o=e.lastIndexOf(n),i=i-n.length;return o!==-1&&o===i}return!1},handleBlockCreated:function(t){var i=this;e.ajax({url:this.getRouteUrl("block_preview",{BLOCK_ID:t.blockId}),type:"GET",success:function(n){var o=e(n);t.$childBlock.replaceWith(o),i.controlChildBlock(o);var a=i.getContainerChildCountFromList(t.parentId);null!==a&&i.updateChildCount(t.parentId,a)},error:function(){i.containerNotification("composer_preview_error","error",!0)}})},handleBlockRemoved:function(e){var t=this.getContainerChildCountFromList(e.parentId);null!==t&&this.updateChildCount(e.parentId,t)},containerNotification:function(t,i,n){var o=this.$dynamicArea.find(".page-composer__container__view__notice");if(1===o.length)if(this.containerNotificationTimer&&clearTimeout(this.containerNotificationTimer),o.removeClass("persist success error"),i&&o.addClass(i),o.text(this.translate(t)),o.show(),n!==!0)this.containerNotificationTimer=setTimeout(function(){o.hide().empty()},2e3);else{var a=e('<span class="close-notice">x</span>');a.on("click",function(){o.hide().empty()}),o.addClass("persist"),o.append(a)}},handleBlockPositionsUpdate:function(t){var i=this;this.containerNotification("composer_update_saving"),e.ajax({url:this.getRouteUrl("save_blocks_positions"),type:"POST",data:{disposition:t.disposition},success:function(e){e.result&&"ok"===e.result&&i.containerNotification("composer_update_saved","success")},error:function(){i.containerNotification("composer_update_error","error",!0)}})},handleBlockParentSwitched:function(t){var i=e(".block-preview-"+t.previousParentId),n=i.find(".child-count"),o=parseInt(n.text().trim(),10),a=e(".block-preview-"+t.newParentId),r=a.find(".child-count"),s=parseInt(r.text().trim(),10);this.updateChildCount(t.previousParentId,o-1),this.updateChildCount(t.newParentId,s+1)},getContainerChildCountFromList:function(t){var i=this.$dynamicArea.find(".block-view-"+t);if(0===i.length)return null;var n=i.find(".page-composer__container__child"),o=0;return n.each(function(){var t=e(this),i=t.attr("data-block-id");"undefined"!=typeof i&&o++}),o},updateChildCount:function(t,i){var n=e(".block-preview-"+t),o=e(".block-view-"+t);n.length>0&&n.find(".child-count").text(i),o.length>0&&o.find(".page-composer__container__child-count span").text(i)},handleBlockCreateFormLoaded:function(t){var n=this,o=this.$dynamicArea.find(".page-composer__container__children"),a=this.$dynamicArea.find(".page-composer__container__main-edition-area");if(t.container){var r=t.container,s=r.find(".page-composer__container__child__content");s.html(t.response)}else{var r=e(['<li class="page-composer__container__child">','<a class="page-composer__container__child__edit">','<h4 class="page-composer__container__child__name">','<input type="text" class="page-composer__container__child__name__input">',"</h4>","</a>",'<div class="page-composer__container__child__right">','<span class="badge">'+t.blockTypeLabel+"</span>","</div>",'<div class="page-composer__container__child__content">',"</div>","</li>"].join("")),s=r.find(".page-composer__container__child__content");s.append(t.response),o.append(r),s.show()}var c,l,d,p=r.find("form"),h=p.attr("action"),u=p.attr("method"),_=p.find("input, select, textarea"),f=p.find(".form-actions"),m=this.$dynamicArea.find(".page-composer__container__child__name");i(p),e(document).scrollTo(r,200),a.show(),_.each(function(){var i=e(this),a=i.attr("name");n.isFormControlTypeByName(a,"name")?(c=i,m.find(".page-composer__container__child__name__input").bind("propertychange keyup input paste",function(t){c.val(e(this).val())})):n.isFormControlTypeByName(a,"parent")?(l=i,l.val(t.containerId),l.parent().parent().hide()):n.isFormControlTypeByName(a,"position")&&(d=i,d.val(o.find("> *").length-1),d.closest(".form-group").hide())}),f.each(function(){var t=e(this),i=e('<span class="btn btn-warning">'+n.translate("cancel")+"</span>");i.on("click",function(t){t.preventDefault(),r.remove(),e(document).scrollTo(n.$dynamicArea,200)}),t.append(i)}),p.on("submit",function(o){o.preventDefault();var a=c.val();return""===a&&(a=t.blockType),e.ajax({url:h+"&"+e.param({composer:1}),data:p.serialize(),type:u,headers:{Accept:"text/html, application/xhtml+xml, application/json;"},success:function(o){if(o.result&&"ok"===o.result&&o.objectId){var c=e.Event("blockcreated");c.$childBlock=r,c.parentId=t.containerId,c.blockId=o.objectId,c.blockName=a,c.blockType=t.blockType,e(n).trigger(c)}else{var l=e.Event("blockcreateformloaded");l.response=o,l.containerId=t.containerId,l.blockType=t.blockType,l.container=r,e(n).trigger(l),i(s)}}}),!1})},toggleChildBlock:function(e){var t="page-composer__container__child--expanded",i=this.$dynamicArea.find(".page-composer__container__child"),n=e.find(".page-composer__container__child__name"),o=n.find(".page-composer__container__child__name__input");e.hasClass(t)?(e.removeClass(t),n.has(".page-composer__container__child__name__input")&&n.html(o.val())):(i.not(e).removeClass(t),e.addClass(t))},handleBlockEditFormLoaded:function(t){var n,o,a=this,r=t.$block.find(".page-composer__container__child__edit h4"),s=t.$block.find(".page-composer__container__child__content"),c=t.$block.find(".page-composer__container__child__loader"),l=s.find("form"),d=l.attr("action"),p=l.attr("method"),h=t.$block.find(".page-composer__container__child__edit small").text().trim();l.find("input").each(function(){var t=e(this),i=t.attr("name");a.isFormControlTypeByName(i,"name")?(n=t,r.html('<input type="text" class="page-composer__container__child__name__input" value="'+r.text().trim()+'">'),$input=r.find("input"),$input.bind("propertychange keyup input paste",function(e){n.val($input.val())}),$input.on("click",function(e){e.stopPropagation(),e.preventDefault()})):a.isFormControlTypeByName(i,"position")&&(o=t,o.closest(".form-group").hide())}),l.on("submit",function(o){return o.preventDefault(),c.show(),e.ajax({url:d,data:l.serialize(),type:p,headers:{Accept:"text/html, application/xhtml+xml, application/json;"},success:function(o){if(c.hide(),o.result&&"ok"===o.result)"undefined"!=typeof n&&r.text(""!==n.val()?n.val():h),t.$block.removeClass("page-composer__container__child--expanded"),s.empty();else{s.html(o);var l=e.Event("blockeditformloaded");l.$block=t.$block,e(a).trigger(l),i(s)}}}),!1})},controlChildBlock:function(t){var n=this,o=t.find(".page-composer__container__child__content"),a=t.find(".page-composer__container__child__loader"),r=t.find(".page-composer__container__child__edit"),s=r.attr("href"),c=t.find(".page-composer__container__child__remove"),l=c.find("a"),d=t.find(".page-composer__container__child__switch-enabled"),p=d.attr("data-label-enable"),h=d.attr("data-label-disable"),u=d.find("a"),_=u.find("i"),f=t.find(".page-composer__container__child__enabled"),m=f.find("small"),v=f.find("i"),g=u.attr("href"),b=parseInt(t.attr("data-block-enabled"),2);r.click(function(r){return r.preventDefault(),o.find("form").length>0?void n.toggleChildBlock(t):(a.show(),void e.ajax({url:s,success:function(r){o.html(r);var s=e.Event("blockeditformloaded");s.$block=t,e(n).trigger(s),i(o),a.hide(),n.toggleChildBlock(t)}}))}),u.on("click",function(i){i.preventDefault(),e.ajax({url:g,type:"POST",data:{_sonata_csrf_token:n.csrfTokens.switchEnabled,value:!b},success:function(i){if(t.attr("data-block-enabled",b?"0":"1"),b=!b,u.toggleClass("bg-yellow bg-green"),_.toggleClass("fa-toggle-off fa-toggle-on"),b?u.html(h):u.html(p),m.toggleClass("bg-yellow bg-green"),v.toggleClass("fa-times fa-check"),t.has("form")){var o=t.find("form"),a=o.find("input");a.each(function(){var t=e(this),i=t.attr("name");n.isFormControlTypeByName(i,"enabled")&&t.val(parseInt(!b))})}},error:function(){n.containerNotification("composer_status_error","error",!0)}})}),l.on("click",function(e){e.preventDefault(),n.confirmRemoveContainer(t)})},confirmRemoveContainer:function(t){var i=this,n=t.find(".page-composer__container__child__remove"),o=n.find("a"),a=t.find(".page-composer__container__child__remove__dialog"),r=o.attr("href"),s=parseInt(t.attr("data-parent-block-id"),10);0==a.length&&(a=e(['<div class="modal fade page-composer__container__child__remove__dialog" tabindex="-1" role="dialog">','<div class="modal-dialog" role="document">','<div class="modal-content">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>','<h4 class="modal-title">'+this.translate("composer_remove_confirm")+"</h4>","</div>",'<div class="modal-body">',"</div>",'<div class="modal-footer">','<button type="button" class="btn btn-default" data-dismiss="modal">'+this.translate("cancel")+"</button>",'<button type="button" class="btn btn-primary">'+this.translate("yes")+"</button>","</div>","</div>","</div>","</div>"].join("")),t.append(a));var c=a.find(".btn-primary");c.on("click",function(n){e.ajax({url:r,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:i.csrfTokens.remove},success:function(n){if(n.result&&"ok"===n.result){t.remove();var o=e.Event("blockremoved");o.parentId=s,e(i).trigger(o)}}}),a.modal("hide"),0!=e(".modal-backdrop").length&&e(".modal-backdrop").hide()}),a.modal("show")},handleContainerLoaded:function(t){var n=this,o=this.$dynamicArea.find(".page-composer__container__children"),a=this.$dynamicArea.find(".page-composer__container__child"),r=this.$dynamicArea.find(".page-composer__block-type-selector"),s=r.find(".page-composer__block-type-selector__loader"),c=r.find("select"),l=r.find(".page-composer__block-type-selector__confirm"),d=l.attr("href");i(this.$dynamicArea),l.on("click",function(i){i.preventDefault(),s.css("display","inline-block");var o=c.val(),a=c.find("option:selected").text().trim();e.ajax({url:d,data:{type:o},success:function(i){s.hide(),e(n).trigger(e.Event("blockcreateformloaded",{response:i,containerId:t.containerId,blockType:o,blockTypeLabel:a}))}})}),o.sortable({revert:!0,cursor:"move",revertDuration:200,delay:200,helper:function(t,i){var n=e(i),o=n.find(".page-composer__container__child__edit h4").text().trim();n.find(".page-composer__container__child__edit small").text().trim();return n.removeClass("page-composer__container__child--expanded"),e('<div class="page-composer__container__child__helper"><h4>'+o+"</h4></div>")},update:function(t,i){var a=[];if(o.find(".page-composer__container__child").each(function(t){var i=e(this),o=i.attr("data-parent-block-id"),r=i.attr("data-block-id");"undefined"!=typeof r&&a.push({id:parseInt(r,10),position:t,parent_id:parseInt(o,10),page_id:n.pageId})}),a.length>0){var r=e.Event("blockpositionsupdate");r.disposition=a,e(n).trigger(r)}}}),a.each(function(){n.controlChildBlock(e(this))})},bindPagePreviewHandlers:function(){var t=this;this.$containerPreviews.each(function(){var i=e(this);i.on("click",function(n){n.preventDefault();var o=e.Event("containerclick");o.$container=i,e(t).trigger(o)})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:!0,connectToSortable:".page-composer__container__children",accept:function(t){var i=e(this).attr("data-block-allowlist");if(""===i)return!0;i=i.split(",");var n=e(t).attr("data-block-type");return i.indexOf(n)!==-1},drop:function(i,n){var o=n.draggable.attr("data-block-id");if("undefined"!=typeof o){n.helper.remove();var a=e(this),r=parseInt(n.draggable.attr("data-parent-block-id"),10),s=parseInt(a.attr("data-block-id"),10);o=parseInt(o,10),r!==s&&(a.addClass("dropped"),a.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(e){a.removeClass("dropped")}),e.ajax({url:t.getRouteUrl("block_switch_parent"),data:{block_id:o,parent_id:s},success:function(i){if(i.result&&"ok"===i.result){n.draggable.remove();var a=e.Event("blockparentswitched");a.previousParentId=r,a.newParentId=s,a.blockId=o,e(t).trigger(a)}}}))}}}),this.$containerPreviews.length>0&&this.loadContainer(this.$containerPreviews.eq(0))},bindOrphansHandlers:function(){var t=this;this.$container.find(".page-composer__orphan-container").each(function(){var i=e(this);i.on("click",function(n){n.preventDefault();var o=e.Event("containerclick");o.$container=i,e(t).trigger(o)})})},loadContainer:function(t){var i=t.attr("href"),n=t.attr("data-block-id"),o=this;this.$dynamicArea.empty(),this.$containerPreviews.removeClass("active"),this.$container.find(".page-composer__orphan-container").removeClass("active"),t.addClass("active"),e.ajax({url:i,success:function(t){o.$dynamicArea.html(t),e(document).scrollTo(o.$dynamicArea,200,{offset:{top:-100}});var i=e.Event("containerloaded");i.containerId=n,e(o).trigger(i)}})}},t.PageComposer=n,e(function(){e("[data-page-composer]").each(function(){var t=e(this).data("page-composer");new n(t.pageId,t)})})}(jQuery,window),function(e,t,i,n){function o(t,i){this.element=t,this.options=e.extend({},s,i),this._defaults=s,this._name=a,this.init()}var a="treeView",r=".js-treeview",s={togglersAttribute:"[data-treeview-toggler]",toggledState:"is-toggled"};o.prototype={init:function(){this.setElements(),this.setEvents()},setElements:function(){this.$element=e(this.element),this.$togglers=this.$element.find(this.options.togglersAttribute)},setEvents:function(){this.$togglers.on("click",e.proxy(this.toggle,this))},toggle:function(t){var i=e(t.currentTarget),n=i.parent();n.toggleClass(this.options.toggledState),n.next("ul").slideToggle()}},e.fn[a]=function(t){return this.each(function(){e.data(this,"plugin_"+a)||e.data(this,"plugin_"+a,new o(this,t))})},e(function(){e(r)[a]()})}(jQuery,window,document);